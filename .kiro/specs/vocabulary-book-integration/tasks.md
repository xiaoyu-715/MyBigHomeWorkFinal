# 实施计划：词汇数据源集成与单词书功能

## 概述

本实施计划将 DictionaryData 数据集集成到现有词汇训练系统，并开发完整的单词书管理功能。采用增量开发方式，确保每个阶段都可独立测试和验证。

## 任务

- [ ] 1. 数据层基础设施搭建
  - [x] 1.1 创建词典单词实体类 DictionaryWordEntity
    - 包含字段：id、word、phoneticUk、phoneticUs、frequency、difficulty、acknowledgeRate、translation
    - 添加索引：word(unique)、difficulty、frequency
    - _需求: 2.1, 2.5_

  - [x] 1.2 创建词书实体类 BookEntity
    - 包含字段：id、parentId、level、bookOrder、name、itemNum、author、fullName、comment、organization、publisher、version、flag
    - 添加索引：parentId、level、bookOrder
    - _需求: 2.3, 2.6_

  - [x] 1.3 创建词书-单词关联实体类 BookWordRelationEntity
    - 包含字段：id、bookId、wordId、flag、tag、wordOrder
    - 添加外键约束和复合索引
    - _需求: 2.4_

  - [x] 1.4 创建单词学习进度实体类 WordLearningProgressEntity
    - 包含字段：id、userId、wordId、bookId、correctCount、wrongCount、isMastered、memoryStrength、lastStudyTime、nextReviewTime、reviewCount
    - 添加索引：(userId, wordId)唯一、nextReviewTime、isMastered
    - _需求: 5.5_

  - [x] 1.5 更新 AppDatabase 添加新实体和DAO
    - 增加数据库版本号
    - 添加迁移策略
    - _需求: 2.7_

- [x] 2. DAO接口实现
  - [x] 2.1 创建 DictionaryWordDao 接口
    - 实现批量插入、按词书查询、搜索、随机获取等方法
    - 支持 LiveData 返回类型
    - _需求: 2.5, 4.1_

  - [x] 2.2 创建 BookDao 接口
    - 实现层级查询、搜索、统计等方法
    - 支持 LiveData 返回类型
    - _需求: 2.6, 3.1, 3.2, 3.5_

  - [x] 2.3 创建 BookWordRelationDao 接口
    - 实现关联查询、批量插入等方法
    - _需求: 4.1_

  - [x] 2.4 创建 WordLearningProgressDao 接口
    - 实现进度查询、更新、统计等方法
    - 支持复习队列查询
    - _需求: 5.1, 5.2, 6.2_

  - [ ]* 2.5 编写属性测试：词书层级查询一致性
    - **Property 3: 词书层级查询一致性**
    - **验证: 需求 2.6, 3.2**

- [x] 3. 数据导入模块
  - [x] 3.1 创建 CSV 解析工具类 CsvParser
    - 支持自定义分隔符（`>` 和 `,`）
    - 处理特殊字符和转义
    - _需求: 1.3, 1.4, 1.5, 1.6_

  - [x] 3.2 创建数据导入器 DictionaryDataImporter
    - 实现异步导入逻辑
    - 支持进度回调
    - 实现批量插入优化（每批1000条）
    - _需求: 1.2, 1.7, 10.3_

  - [x] 3.3 实现数据初始化检测和状态管理
    - 使用 SharedPreferences 存储导入状态
    - 支持增量更新检测
    - _需求: 1.1, 1.8, 1.9_

  - [x] 3.4 将 DictionaryData CSV 文件复制到 assets 目录
    - 复制 word.csv、word_translation.csv、book.csv
    - 解压并复制 relation_book_word.csv
    - _需求: 1.2_

  - [x] 3.5 实现应用启动时的数据初始化
    - 在 Application 类中触发后台导入
    - 显示导入进度（首次启动）
    - _需求: 1.1, 10.5_

  - [ ]* 3.6 编写属性测试：CSV解析往返一致性
    - **Property 1: CSV解析往返一致性**
    - **验证: 需求 1.3, 1.4, 1.5, 1.6**

  - [ ]* 3.7 编写属性测试：数据导入幂等性
    - **Property 2: 数据导入幂等性**
    - **验证: 需求 1.9**

- [x] 4. 检查点 - 数据层完成验证
  - 确保所有数据实体正确创建
  - 确保数据导入功能正常工作
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. Repository层实现
  - [x] 5.1 创建 BookRepository
    - 封装词书相关的数据访问逻辑
    - 提供 LiveData 接口
    - _需求: 3.1, 3.2, 3.4_

  - [x] 5.2 创建 DictionaryWordRepository
    - 封装单词相关的数据访问逻辑
    - 实现单词与翻译的合并查询
    - _需求: 4.1, 4.7_

  - [x] 5.3 创建 LearningProgressRepository
    - 封装学习进度相关的数据访问逻辑
    - 实现进度统计计算
    - _需求: 5.1, 5.2, 5.3_

  - [ ]* 5.4 编写属性测试：学习进度统计一致性
    - **Property 6: 学习进度统计一致性**
    - **验证: 需求 5.1, 5.2, 5.3**

- [x] 6. 单词书浏览功能
  - [x] 6.1 创建 VocabularyBookActivity
    - 实现词书列表和详情的容器Activity
    - 配置 Fragment 导航
    - _需求: 3.1_

  - [x] 6.2 创建 BookListFragment
    - 实现词书分类列表展示
    - 支持层级导航（点击分类进入子分类）
    - 实现搜索功能
    - _需求: 3.1, 3.2, 3.5_
    - 注：已在VocabularyBookActivity中直接实现，无需单独Fragment

  - [x] 6.3 创建 BookDetailFragment
    - 显示词书详细信息
    - 显示单词预览列表
    - 显示学习进度
    - _需求: 3.4, 3.7_
    - 注：已创建BookDetailActivity实现

  - [x] 6.4 创建 BookViewModel
    - 管理词书列表状态
    - 处理搜索逻辑
    - _需求: 3.1, 3.5_

  - [x] 6.5 创建词书列表布局文件
    - activity_vocabulary_book.xml
    - fragment_book_list.xml
    - fragment_book_detail.xml
    - item_book.xml
    - _需求: 3.3_

  - [x] 6.6 创建 BookAdapter
    - 实现词书列表的 RecyclerView 适配器
    - 显示词书名称、单词数量、作者、学习进度
    - _需求: 3.3, 3.7_

  - [ ]* 6.7 编写属性测试：词书搜索结果相关性
    - **Property 5: 词书搜索结果相关性**
    - **验证: 需求 3.5**

- [ ] 7. 检查点 - 词书浏览功能验证
  - 确保词书列表正确显示
  - 确保层级导航正常工作
  - 确保搜索功能正常，如有问题请询问用户

- [ ] 8. 词书学习功能
  - [ ] 8.1 重构 VocabularyActivity 支持词书数据源
    - 添加词书ID参数
    - 从数据库加载词书单词
    - 保持与现有硬编码数据的兼容
    - _需求: 4.1, 4.2_

  - [ ] 8.2 创建 VocabularyTrainingViewModel
    - 管理训练状态和单词队列
    - 处理答题逻辑
    - 支持断点续学
    - _需求: 4.3, 4.4, 4.5_

  - [ ] 8.3 实现学习进度保存
    - 每答一题保存进度
    - 记录正确/错误次数
    - 更新掌握状态
    - _需求: 4.3, 5.5_

  - [ ] 8.4 实现断点续学功能
    - 保存当前学习位置
    - 恢复上次学习进度
    - _需求: 4.5_

  - [ ] 8.5 添加学习数量设置
    - 支持选择每次学习单词数（10/20/30/50）
    - 保存用户偏好设置
    - _需求: 4.6_

  - [ ]* 8.6 编写属性测试：词书单词归属一致性
    - **Property 7: 词书单词归属一致性**
    - **验证: 需求 4.1**

- [ ] 9. 智能复习功能
  - [ ] 9.1 实现艾宾浩斯遗忘曲线算法
    - 计算下次复习时间
    - 根据记忆强度调整间隔
    - _需求: 6.1_

  - [ ] 9.2 实现复习队列管理
    - 查询需要复习的单词
    - 按优先级排序
    - _需求: 6.2, 6.3_

  - [ ] 9.3 实现复习间隔动态调整
    - 答对延长间隔
    - 答错缩短间隔
    - _需求: 6.4, 6.5_

  - [ ] 9.4 添加今日复习统计
    - 显示今日需复习单词数
    - 在主页显示复习提醒
    - _需求: 6.6_

  - [ ]* 9.5 编写属性测试：艾宾浩斯复习间隔一致性
    - **Property 8: 艾宾浩斯复习间隔一致性**
    - **验证: 需求 6.1, 6.4, 6.5**

  - [ ]* 9.6 编写属性测试：复习队列筛选一致性
    - **Property 9: 复习队列筛选一致性**
    - **验证: 需求 6.2, 6.3**

- [ ] 10. 检查点 - 学习和复习功能验证
  - 确保词书学习功能正常
  - 确保复习系统正确计算间隔
  - 确保所有测试通过，如有问题请询问用户

- [ ] 11. 训练模式增强
  - [ ] 11.1 实现"看词选义"模式
    - 显示单词，选择中文释义
    - 生成干扰选项
    - _需求: 8.1_

  - [ ] 11.2 实现"看义选词"模式
    - 显示中文释义，选择单词
    - 生成干扰选项
    - _需求: 8.2_

  - [ ] 11.3 实现"听音选词"模式
    - 播放发音，选择单词
    - 集成现有发音功能
    - _需求: 8.3_

  - [ ] 11.4 实现"拼写模式"
    - 显示中文释义，用户输入单词
    - 支持模糊匹配和提示
    - _需求: 8.4_

  - [ ] 11.5 创建训练模式选择界面
    - 模式选择对话框
    - 保存用户偏好
    - _需求: 8.5_

  - [ ] 11.6 实现训练统计按模式分类
    - 记录每种模式的训练数据
    - 在报告中显示分类统计
    - _需求: 8.6_

  - [ ]* 11.7 编写属性测试：训练模式题目生成一致性
    - **Property 10: 训练模式题目生成一致性**
    - **验证: 需求 8.1, 8.2, 8.3, 8.4, 8.5**

- [ ] 12. 发音功能增强
  - [ ] 12.1 添加英式/美式发音切换
    - 在设置中添加发音偏好选项
    - 根据设置选择发音类型
    - _需求: 7.2_

  - [ ] 12.2 实现自动播放发音设置
    - 添加自动播放开关
    - 显示单词时自动播放
    - _需求: 7.5_

  - [ ] 12.3 优化发音错误处理
    - 网络不可用时显示友好提示
    - 播放中禁用按钮
    - _需求: 7.3, 7.4_

- [ ] 13. 数据备份功能
  - [ ] 13.1 实现学习数据导出
    - 导出为JSON格式
    - 包含所有学习进度数据
    - _需求: 9.2_

  - [ ] 13.2 实现学习数据导入
    - 从JSON文件导入
    - 支持合并或覆盖选项
    - _需求: 9.3, 9.4_

  - [ ] 13.3 添加备份/恢复界面
    - 在设置页面添加入口
    - 显示导出文件路径
    - _需求: 9.5_

  - [ ]* 13.4 编写属性测试：数据导出导入往返一致性
    - **Property 11: 数据导出导入往返一致性**
    - **验证: 需求 9.2, 9.3**

- [ ] 14. 性能优化
  - [ ] 14.1 实现词书列表分页加载
    - 使用 Paging 3 库
    - 每页加载50条
    - _需求: 10.1_

  - [ ] 14.2 优化搜索性能
    - 添加搜索防抖
    - 使用 FTS 全文搜索（可选）
    - _需求: 10.2_

  - [ ]* 14.3 编写属性测试：分页加载数量限制
    - **Property 12: 分页加载数量限制**
    - **验证: 需求 10.1**

- [ ] 15. 主页集成
  - [x] 15.1 在主页添加单词书入口
    - 添加"单词书"功能卡片
    - 显示学习进度概览
    - _需求: 3.1_

  - [ ] 15.2 添加今日复习提醒
    - 在主页显示待复习单词数
    - 点击进入复习模式
    - _需求: 6.6_

  - [ ] 15.3 更新学习报告
    - 添加词书学习统计
    - 显示各词书完成进度
    - _需求: 5.6_

- [ ] 16. 最终检查点 - 全功能验证
  - 确保所有功能正常工作
  - 确保所有测试通过
  - 确保性能满足要求，如有问题请询问用户

## 注意事项

- 标记 `*` 的任务为可选测试任务，可根据时间安排选择性实施
- 每个检查点都需要确保前序任务全部完成并通过测试
- 数据导入涉及大量数据，需要在后台线程执行
- 保持与现有 VocabularyActivity 的兼容性，避免破坏现有功能
